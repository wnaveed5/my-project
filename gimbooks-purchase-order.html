<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Purchase Order</title>
            <link href="./dist/output.css?v=1.0.2" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8fafc;
            padding: 20px;
        }
        
        .container {
            max-width: 8.5in;
            margin: 0 auto;
            background: white;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            border-radius: 8px;
            overflow: hidden;
        }
    </style>
</head>
<body>
    <table class="container">
        <tr>
            <td style="padding: 30px;">
                <!-- Header Section -->
                <table style="width: 100%; margin-bottom: 30px;">
                    <tr>
                        <td style="width: 60%; vertical-align: top;">
                            <table style="width: 100%;">
                                <tr>
                                    <td style="padding-top: 15px;">
                                        <table style="width: 100%;">
                                            <tr><td>Company Name: <span class="editable-field" contenteditable="true" data-placeholder="">Test Company Inc</span></td></tr>
                                            <tr><td>Street Address: <span class="editable-field" contenteditable="true" data-placeholder="">123 Main Street</span></td></tr>
                                            <tr><td>City, ST ZIP: <span class="editable-field" contenteditable="true" data-placeholder="">New York, NY 10001</span></td></tr>
                                            <tr><td>Phone: <span class="editable-field" contenteditable="true" data-placeholder="">(555) 123-4567</span></td></tr>
                                            <tr><td>Fax: <span class="editable-field" contenteditable="true" data-placeholder="">(555) 123-4568</span></td></tr>
                                            <tr><td>Website: <span class="editable-field" contenteditable="true" data-placeholder="">www.testcompany.com</span></td></tr>
                                        </table>
                                    </td>
                                </tr>
                            </table>
                        </td>
                        
                        <td style="width: 40%; text-align: center; vertical-align: top;">
                            <table style="width: 100%;">
                                <tr>
                                    <td style="text-align: center;">
                                        <div style="font-size: 32px; font-weight: bold; color: #000000; margin-bottom: 20px;">PURCHASE ORDER</div>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <table style="width: 100%;">
                                            <tr>
                                                <td style="text-align: right; padding-right: 10px; font-weight: bold;">DATE:</td>
                                                <td><span class="editable-field" contenteditable="true" data-placeholder="">2024-12-19</span></td>
                                            </tr>
                                            <tr>
                                                <td style="text-align: right; padding-right: 10px; font-weight: bold;">PO #:</td>
                                                <td><span class="editable-field" contenteditable="true" data-placeholder="">PO-001</span></td>
                                            </tr>
                                        </table>
                                    </td>
                                </tr>
                            </table>
                        </td>
                    </tr>
                </table>
                
                <!-- Vendor and Ship To Section -->
                <table style="width: 100%; margin-bottom: 30px;">
                    <tr>
                        <td style="width: 50%; padding-right: 15px; vertical-align: top;">
                            <table style="width: 100%; border: 1px solid #e5e7eb;">
                                <tr>
                                    <td class="section-header">VENDOR</td>
                                </tr>
                                <tr>
                                    <td style="padding: 15px;">
                                        <table style="width: 100%;">
                                            <tr><td>Company Name: <span class="editable-field" contenteditable="true" data-placeholder="">ABC Supplies Ltd</span></td></tr>
                                            <tr><td>Contact or Department: <span class="editable-field" contenteditable="true" data-placeholder="">Procurement Dept</span></td></tr>
                                            <tr><td>Street Address: <span class="editable-field" contenteditable="true" data-placeholder="">456 Vendor Street</span></td></tr>
                                            <tr><td>City, ST ZIP: <span class="editable-field" contenteditable="true" data-placeholder="">Los Angeles, CA 90210</span></td></tr>
                                            <tr><td>Phone: <span class="editable-field" contenteditable="true" data-placeholder="">(310) 555-0123</span></td></tr>
                                            <tr><td>Fax: <span class="editable-field" contenteditable="true" data-placeholder="">(310) 555-0124</span></td></tr>
                                        </table>
                                    </td>
                                </tr>
                            </table>
                        </td>
                        
                        <td style="width: 50%; padding-left: 15px; vertical-align: top;">
                            <table style="width: 100%; border: 1px solid #e5e7eb;">
                                <tr>
                                    <td class="section-header">SHIP TO</td>
                                </tr>
                                <tr>
                                    <td style="padding: 15px;">
                                        <table style="width: 100%;">
                                            <tr><td>Name: <span class="editable-field" contenteditable="true" data-placeholder="">John Smith</span></td></tr>
                                            <tr><td>Company Name: <span class="editable-field" contenteditable="true" data-placeholder="">Test Company Inc</span></td></tr>
                                            <tr><td>Street Address: <span class="editable-field" contenteditable="true" data-placeholder="">123 Main Street</span></td></tr>
                                            <tr><td>City, ST ZIP: <span class="editable-field" contenteditable="true" data-placeholder="">New York, NY 10001</span></td></tr>
                                            <tr><td>Phone: <span class="editable-field" contenteditable="true" data-placeholder="">(555) 123-4567</span></td></tr>
                                        </table>
                                    </td>
                                </tr>
                            </table>
                        </td>
                    </tr>
                </table>
                
                <!-- Shipping Details Row -->
                <table style="width: 100%; margin-bottom: 30px;">
                    <tr>
                        <td style="width: 25%; padding-right: 7px;">
                            <table style="width: 100%; border: 1px solid #e5e7eb;">
                                <tr>
                                    <td class="section-header">REQUISITIONER</td>
                                </tr>
                                <tr>
                                    <td style="padding: 10px; height: 40px;">
                                        <span class="editable-field" contenteditable="true" data-placeholder="">Jane Doe</span>
                                    </td>
                                </tr>
                            </table>
                        </td>
                        
                        <td style="width: 25%; padding-right: 7px; padding-left: 7px;">
                            <table style="width: 100%; border: 1px solid #e5e7eb;">
                                <tr>
                                    <td class="section-header">SHIP VIA</td>
                                </tr>
                                <tr>
                                    <td style="padding: 10px; height: 40px;">
                                        <span class="editable-field" contenteditable="true" data-placeholder="">FedEx Ground</span>
                                    </td>
                                </tr>
                            </table>
                        </td>
                        
                        <td style="width: 25%; padding-right: 7px; padding-left: 7px;">
                            <table style="width: 100%; border: 1px solid #e5e7eb;">
                                <tr>
                                    <td class="section-header">F.O.B.</td>
                                </tr>
                                <tr>
                                    <td style="padding: 10px; height: 40px;">
                                        <span class="editable-field" contenteditable="true" data-placeholder="">Origin</span>
                                    </td>
                                </tr>
                            </table>
                        </td>
                        
                        <td style="width: 25%; padding-left: 7px;">
                            <table style="width: 100%; border: 1px solid #e5e7eb;">
                                <tr>
                                    <td class="section-header">SHIPPING TERMS</td>
                                </tr>
                                <tr>
                                    <td style="padding: 10px; height: 40px;">
                                        <span class="editable-field" contenteditable="true" data-placeholder="">Net 30</span>
                                    </td>
                                </tr>
                            </table>
                        </td>
                    </tr>
                </table>
                
                <!-- Items Table - NetSuite Compatible Structure -->
                <table class="itemtable" style="width: 100%; margin-bottom: 30px; border: 1px solid #e5e7eb;">
                    <!-- Header Row with NetSuite-style column spans -->
                    <thead>
                        <tr>
                            <th colspan="12" align="center" style="background: #333333; color: white; padding: 12px; font-weight: bold;">Item#</th>
                            <th colspan="12" style="background: #333333; color: white; padding: 12px; font-weight: bold;">Description</th>
                            <th colspan="3" align="center" style="background: #333333; color: white; padding: 12px; font-weight: bold;">Qty</th>
                            <th colspan="4" align="right" style="background: #333333; color: white; padding: 12px; font-weight: bold;">Unit Price</th>
                            <th colspan="4" align="right" style="background: #333333; color: white; padding: 12px; font-weight: bold;">Total Price</th>
                        </tr>
                    </thead>
                    
                    <!-- Sample Row 1 -->
                    <tr>
                        <td colspan="12" style="padding: 10px; border-bottom: 1px solid #e5e7eb; text-align: center; line-height: 150%;">
                            <span class="editable-field" contenteditable="true" data-placeholder="">ITEM-001</span>
                        </td>
                        <td colspan="12" style="padding: 10px; border-bottom: 1px solid #e5e7eb;">
                            <span class="editable-field" contenteditable="true" data-placeholder="">Office Supplies Package</span>
                        </td>
                        <td colspan="3" style="padding: 10px; border-bottom: 1px solid #e5e7eb; text-align: center; line-height: 150%;">
                            <span class="editable-field" contenteditable="true" data-placeholder="">25</span>
                        </td>
                        <td colspan="4" align="right" style="padding: 10px; border-bottom: 1px solid #e5e7eb;">
                            <span class="editable-field" contenteditable="true" data-placeholder="">15.99</span>
                        </td>
                        <td colspan="4" align="right" style="padding: 10px; border-bottom: 1px solid #e5e7eb;">
                            <span class="editable-field" contenteditable="true" data-placeholder="">399.75</span>
                        </td>
                    </tr>
                    
                    <!-- Sample Row 2 -->
                    <tr>
                        <td colspan="12" style="padding: 10px; border-bottom: 1px solid #e5e7eb; text-align: center; line-height: 150%;">
                            <span class="editable-field" contenteditable="true" data-placeholder="">[45645645]</span>
                        </td>
                        <td colspan="12" style="padding: 10px; border-bottom: 1px solid #e5e7eb;">
                            <span class="editable-field" contenteditable="true" data-placeholder="">Product ABC</span>
                        </td>
                        <td colspan="3" style="padding: 10px; border-bottom: 1px solid #e5e7eb; text-align: center; line-height: 150%;">
                            <span class="editable-field" contenteditable="true" data-placeholder="">1</span>
                        </td>
                        <td colspan="4" align="right" style="padding: 10px; border-bottom: 1px solid #e5e7eb;">
                            <span class="editable-field" contenteditable="true" data-placeholder="">75.00</span>
                        </td>
                        <td colspan="4" align="right" style="padding: 10px; border-bottom: 1px solid #e5e7eb;">
                            <span class="editable-field" contenteditable="true" data-placeholder="">75.00</span>
                        </td>
                    </tr>
                    
                    <!-- Empty Row 3 for Additional Items -->
                    <tr>
                        <td colspan="12" style="padding: 10px; border-bottom: 1px solid #e5e7eb; text-align: center; line-height: 150%;">
                            <span class="editable-field" contenteditable="true" data-placeholder=""></span>
                        </td>
                        <td colspan="12" style="padding: 10px; border-bottom: 1px solid #e5e7eb;">
                            <span class="editable-field" contenteditable="true" data-placeholder=""></span>
                        </td>
                        <td colspan="3" style="padding: 10px; border-bottom: 1px solid #e5e7eb; text-align: center; line-height: 150%;">
                            <span class="editable-field" contenteditable="true" data-placeholder=""></span>
                        </td>
                        <td colspan="4" align="right" style="padding: 10px; border-bottom: 1px solid #e5e7eb;">
                            <span class="editable-field" contenteditable="true" data-placeholder=""></span>
                        </td>
                        <td colspan="4" align="right" style="padding: 10px; border-bottom: 1px solid #e5e7eb;">
                            <span class="editable-field" contenteditable="true" data-placeholder=""></span>
                        </td>
                    </tr>
                    
                    <!-- Empty Row 4 for Additional Items -->
                    <tr>
                        <td colspan="12" style="padding: 10px; border-bottom: 1px solid #e5e7eb; text-align: center; line-height: 150%;">
                            <span class="editable-field" contenteditable="true" data-placeholder=""></span>
                        </td>
                        <td colspan="12" style="padding: 10px; border-bottom: 1px solid #e5e7eb;">
                            <span class="editable-field" contenteditable="true" data-placeholder=""></span>
                        </td>
                        <td colspan="3" style="padding: 10px; border-bottom: 1px solid #e5e7eb; text-align: center; line-height: 150%;">
                            <span class="editable-field" contenteditable="true" data-placeholder=""></span>
                        </td>
                        <td colspan="4" align="right" style="padding: 10px; border-bottom: 1px solid #e5e7eb;">
                            <span class="editable-field" contenteditable="true" data-placeholder=""></span>
                        </td>
                        <td colspan="4" align="right" style="padding: 10px; border-bottom: 1px solid #e5e7eb;">
                            <span class="editable-field" contenteditable="true" data-placeholder=""></span>
                        </td>
                    </tr>
                    
                    <!-- Empty Row 5 for Additional Items -->
                    <tr>
                        <td colspan="12" style="padding: 10px; border-bottom: 1px solid #e5e7eb; text-align: center; line-height: 150%;">
                            <span class="editable-field" contenteditable="true" data-placeholder=""></span>
                        </td>
                        <td colspan="12" style="padding: 10px; border-bottom: 1px solid #e5e7eb;">
                            <span class="editable-field" contenteditable="true" data-placeholder=""></span>
                        </td>
                        <td colspan="3" style="padding: 10px; border-bottom: 1px solid #e5e7eb; text-align: center; line-height: 150%;">
                            <span class="editable-field" contenteditable="true" data-placeholder=""></span>
                        </td>
                        <td colspan="4" align="right" style="padding: 10px; border-bottom: 1px solid #e5e7eb;">
                            <span class="editable-field" contenteditable="true" data-placeholder=""></span>
                        </td>
                        <td colspan="4" align="right" style="padding: 10px; border-bottom: 1px solid #e5e7eb;">
                            <span class="editable-field" contenteditable="true" data-placeholder=""></span>
                        </td>
                    </tr>
                </table>
                
                <!-- Summary and Comments Section -->
                <table style="width: 100%; margin-bottom: 30px;">
                    <tr>
                        <td style="width: 70%; padding-right: 15px; vertical-align: top;">
                            <table style="width: 100%; border: 1px solid #e5e7eb;">
                                <tr>
                                    <td class="section-header">Comments or Special Instructions</td>
                                </tr>
                                <tr>
                                    <td style="padding: 15px; height: 120px;">
                                        <span class="editable-field" contenteditable="true" data-placeholder="" style="display: block; width: 100%; height: 100%;">Please deliver to the main office entrance. Contact John Smith upon arrival.</span>
                                    </td>
                                </tr>
                            </table>
                        </td>
                        
                        <td style="width: 30%; padding-left: 15px; vertical-align: top;">
                            <table style="width: 100%; border: 1px solid #e5e7eb;">
                                <tr>
                                    <td style="padding: 15px;">
                                        <table style="width: 100%;">
                                            <tr>
                                                <td style="padding: 5px 0; font-weight: bold; color: #000000;">SUBTOTAL:</td>
                                                <td style="text-align: right; padding: 5px 0; color: #000000;"><span class="editable-field" contenteditable="true" data-placeholder="">399.75</span></td>
                                            </tr>
                                            <tr>
                                                <td style="padding: 5px 0; font-weight: bold; color: #000000;">TAX:</td>
                                                <td style="text-align: right; padding: 5px 0; color: #000000;"><span class="editable-field" contenteditable="true" data-placeholder="">32.98</span></td>
                                            </tr>
                                            <tr>
                                                <td style="padding: 5px 0; font-weight: bold; color: #000000;">SHIPPING:</td>
                                                <td style="text-align: right; padding: 5px 0; color: #000000;"><span class="editable-field" contenteditable="true" data-placeholder="">25.00</span></td>
                                            </tr>
                                            <tr>
                                                <td style="padding: 5px 0; font-weight: bold; color: #000000;">OTHER:</td>
                                                <td style="text-align: right; padding: 5px 0; color: #000000;"><span class="editable-field" contenteditable="true" data-placeholder="">0.00</span></td>
                                            </tr>
                                            <tr>
                                                <td colspan="2" style="padding-top: 15px;">
                                                    <div style="text-align: center; color: #000000;">
                                                        TOTAL: $<span class="editable-field" contenteditable="true" data-placeholder="">457.73</span>
                                                    </div>
                                                </td>
                                            </tr>
                                        </table>
                                    </td>
                                </tr>
                            </table>
                        </td>
                    </tr>
                </table>
                
                <!-- Convert to XML Button -->
                <table style="width: 100%; text-align: center; margin-top: 30px;">
                    <tr>
                        <td>
                            <button id="convertToXmlBtn" style="
                                background: #333333;
                                color: white;
                                border: none;
                                padding: 12px 24px;
                                font-size: 16px;
                                border-radius: 6px;
                                cursor: pointer;
                                transition: background 0.3s ease;
                            " onmouseover="this.style.background='#555555'" onmouseout="this.style.background='#333333'">
                                🔄 Convert to NetSuite XML
                            </button>
                        </td>
                    </tr>
                </table>
                
                <!-- XML Output Modal -->
                <div id="xmlModal" style="
                    display: none;
                    position: fixed;
                    z-index: 1000;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    background-color: rgba(0,0,0,0.5);
                ">
                    <div style="
                        background-color: white;
                        margin: 5% auto;
                        padding: 20px;
                        border-radius: 8px;
                        width: 90%;
                        max-width: 800px;
                        max-height: 80vh;
                        overflow-y: auto;
                    ">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h2 style="margin: 0; color: #333;">NetSuite XML Output</h2>
                            <button onclick="closeXmlModal()" style="
                                background: #333333;
                                color: white;
                                border: none;
                                padding: 8px 16px;
                                border-radius: 4px;
                                cursor: pointer;
                            ">✕ Close</button>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <button onclick="copyXmlToClipboard()" style="
                                background: #666666;
                                color: white;
                                border: none;
                                padding: 8px 16px;
                                border-radius: 4px;
                                cursor: pointer;
                                margin-right: 10px;
                            ">📋 Copy XML</button>
                            <button onclick="downloadXml()" style="
                                background: #999999;
                                color: white;
                                border: none;
                                padding: 8px 16px;
                                border-radius: 4px;
                                cursor: pointer;
                            ">💾 Download XML</button>
                        </div>
                        
                        <div style="
                            background: #f8f9fa;
                            border: 1px solid #dee2e6;
                            border-radius: 4px;
                            padding: 15px;
                            font-family: 'Courier New', monospace;
                            font-size: 12px;
                            white-space: pre-wrap;
                            overflow-x: auto;
                            max-height: 400px;
                            overflow-y: auto;
                        " id="xmlOutput"></div>
                        
                        <div style="margin-top: 20px; padding: 15px; background: #f5f5f5; border-radius: 4px; border-left: 4px solid #333333;">
                            <h4 style="margin: 0 0 10px 0; color: #000000;">📖 NetSuite Integration Guide</h4>
                            <ol style="margin: 0; padding-left: 20px; color: #000000;">
                                <li>Copy the XML above using the "Copy XML" button</li>
                                <li>Open NetSuite Advanced PDF/HTML Templates</li>
                                <li>Switch to "Source Code" mode</li>
                                <li>Paste the XML and save</li>
                                <li>Preview and adjust as needed</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </td>
        </tr>
    </table>

    <script>
        // Comprehensive field mapping configuration
        const FIELD_MAPPING = {
            // Company Info
            companyName: 'td[style*="width: 60%"] table tr:nth-child(1) td table tr:nth-child(1) td .editable-field',
            companyAddress: 'td[style*="width: 60%"] table tr:nth-child(1) td table tr:nth-child(2) td .editable-field',
            companyCityState: 'td[style*="width: 60%"] table tr:nth-child(1) td table tr:nth-child(3) td .editable-field',
            companyPhone: 'td[style*="width: 60%"] table tr:nth-child(1) td table tr:nth-child(4) td .editable-field',
            companyFax: 'td[style*="width: 60%"] table tr:nth-child(1) td table tr:nth-child(5) td .editable-field',
            companyWebsite: 'td[style*="width: 60%"] table tr:nth-child(1) td table tr:nth-child(6) td .editable-field',
            
            // PO Details
            poDate: 'td[style*="width: 40%"] table tr:nth-child(2) td table tr:nth-child(1) td:last-child .editable-field',
            poNumber: 'td[style*="width: 40%"] table tr:nth-child(2) td table tr:nth-child(2) td:last-child .editable-field',
            
            // Vendor Section
            vendorCompany: 'td[style*="width: 50%"]:first-child table tr:nth-child(2) td table tr:nth-child(1) td .editable-field',
            vendorContact: 'td[style*="width: 50%"]:first-child table tr:nth-child(2) td table tr:nth-child(2) td .editable-field',
            vendorAddress: 'td[style*="width: 50%"]:first-child table tr:nth-child(2) td table tr:nth-child(3) td .editable-field',
            vendorCityState: 'td[style*="width: 50%"]:first-child table tr:nth-child(2) td table tr:nth-child(4) td .editable-field',
            vendorPhone: 'td[style*="width: 50%"]:first-child table tr:nth-child(2) td table tr:nth-child(5) td .editable-field',
            vendorFax: 'td[style*="width: 50%"]:first-child table tr:nth-child(2) td table tr:nth-child(6) td .editable-field',
            
            // Ship To Section
            shipToName: 'td[style*="width: 50%"]:last-child table tr:nth-child(2) td table tr:nth-child(1) td .editable-field',
            shipToCompany: 'td[style*="width: 50%"]:last-child table tr:nth-child(2) td table tr:nth-child(2) td .editable-field',
            shipToAddress: 'td[style*="width: 50%"]:last-child table tr:nth-child(2) td table tr:nth-child(3) td .editable-field',
            shipToCityState: 'td[style*="width: 50%"]:last-child table tr:nth-child(2) td table tr:nth-child(4) td .editable-field',
            shipToPhone: 'td[style*="width: 50%"]:last-child table tr:nth-child(2) td table tr:nth-child(5) td .editable-field',
            
            // Shipping Details
            requisitioner: 'td[style*="width: 25%"]:nth-of-type(1) .editable-field',
            shipVia: 'td[style*="width: 25%"]:nth-of-type(2) .editable-field',
            fob: 'td[style*="width: 25%"]:nth-of-type(3) .editable-field',
            shippingTerms: 'td[style*="width: 25%"]:nth-of-type(4) .editable-field',
            
            // Line Items (up to 5 items) - Fixed to match actual HTML structure
            lineItem1Qty: 'table.itemtable tbody tr:nth-child(1) td:nth-child(1) .editable-field',
            lineItem1Item: 'table.itemtable tbody tr:nth-child(1) td:nth-child(2) .itemname .editable-field',
            lineItem1Desc: 'table.itemtable tbody tr:nth-child(1) td:nth-child(2) .editable-field:nth-of-type(2)',
            lineItem1Options: 'table.itemtable tbody tr:nth-child(1) td:nth-child(3) .editable-field',
            lineItem1Rate: 'table.itemtable tbody tr:nth-child(1) td:nth-child(4) .editable-field',
            lineItem1Amount: 'table.itemtable tbody tr:nth-child(1) td:nth-child(5) .editable-field',
            
            lineItem2Qty: 'table.itemtable tbody tr:nth-child(2) td:nth-child(1) .editable-field',
            lineItem2Item: 'table.itemtable tbody tr:nth-child(2) td:nth-child(2) .itemname .editable-field',
            lineItem2Desc: 'table.itemtable tbody tr:nth-child(2) td:nth-child(2) .editable-field:nth-of-type(2)',
            lineItem2Options: 'table.itemtable tbody tr:nth-child(2) td:nth-child(3) .editable-field',
            lineItem2Rate: 'table.itemtable tbody tr:nth-child(2) td:nth-child(4) .editable-field',
            lineItem2Amount: 'table.itemtable tbody tr:nth-child(2) td:nth-child(5) .editable-field',
            
            lineItem3Qty: 'table.itemtable tbody tr:nth-child(3) td:nth-child(1) .editable-field',
            lineItem3Item: 'table.itemtable tbody tr:nth-child(3) td:nth-child(2) .itemname .editable-field',
            lineItem3Desc: 'table.itemtable tbody tr:nth-child(3) td:nth-child(2) .editable-field:nth-of-type(2)',
            lineItem3Options: 'table.itemtable tbody tr:nth-child(3) td:nth-child(3) .editable-field',
            lineItem3Rate: 'table.itemtable tbody tr:nth-child(3) td:nth-child(4) .editable-field',
            lineItem3Amount: 'table.itemtable tbody tr:nth-child(3) td:nth-child(5) .editable-field',
            
            lineItem4Qty: 'table.itemtable tbody tr:nth-child(4) td:nth-child(1) .editable-field',
            lineItem4Item: 'table.itemtable tbody tr:nth-child(4) td:nth-child(2) .itemname .editable-field',
            lineItem4Desc: 'table.itemtable tbody tr:nth-child(4) td:nth-child(2) .editable-field:nth-of-type(2)',
            lineItem4Options: 'table.itemtable tbody tr:nth-child(4) td:nth-child(3) .editable-field',
            lineItem4Rate: 'table.itemtable tbody tr:nth-child(4) td:nth-child(4) .editable-field',
            lineItem4Amount: 'table.itemtable tbody tr:nth-child(4) td:nth-child(5) .editable-field',
            
            lineItem5Qty: 'table.itemtable tbody tr:nth-child(5) td:nth-child(1) .editable-field',
            lineItem5Item: 'table.itemtable tbody tr:nth-child(5) td:nth-child(2) .itemname .editable-field',
            lineItem5Desc: 'table.itemtable tbody tr:nth-child(5) td:nth-child(2) .editable-field:nth-of-type(2)',
            lineItem5Options: 'table.itemtable tbody tr:nth-child(5) td:nth-child(3) .editable-field',
            lineItem5Rate: 'table.itemtable tbody tr:nth-child(5) td:nth-child(4) .editable-field',
            lineItem5Amount: 'table.itemtable tbody tr:nth-child(5) td:nth-child(5) .editable-field',
            
            // Totals Section
            subtotal: 'td[style*="width: 30%"] table tr:nth-child(1) td:last-child .editable-field',
            tax: 'td[style*="width: 30%"] table tr:nth-child(2) td:last-child .editable-field',
            shipping: 'td[style*="width: 30%"] table tr:nth-child(3) td:last-child .editable-field',
            other: 'td[style*="width: 30%"] table tr:nth-child(4) td:last-child .editable-field',
            total: 'td[style*="width: 30%"] table tr:nth-child(5) td:last-child .editable-field',
            
            // Comments Section
            comments: 'td[style*="width: 70%"] .editable-field',
            
            // Footer Contact
            contactInfo: 'table[style*="border-top: 2px solid #22c55e"] .editable-field'
        };

        // Field validation function - now shows field status without blocking conversion
        function validateAllFields() {
            console.group('🔍 Field Validation Check');
            const validationResults = {};
            let filledCount = 0;
            let emptyCount = 0;
            
            for (const [fieldName, selector] of Object.entries(FIELD_MAPPING)) {
                const element = document.querySelector(selector);
                const value = element?.textContent.trim() || '';
                const isEmpty = !value;
                
                validationResults[fieldName] = {
                    value: value,
                    isEmpty: isEmpty,
                    element: element,
                    selector: selector
                };
                
                if (isEmpty) {
                    emptyCount++;
                    console.log(`⚪ ${fieldName}: EMPTY`);
                    // Remove any highlighting from empty fields
                    if (element) {
                        element.style.backgroundColor = '';
                        element.style.border = '';
                    }
                } else {
                    filledCount++;
                    console.log(`✅ ${fieldName}: "${value}"`);
                    // Remove any highlighting from filled fields
                    if (element) {
                        element.style.backgroundColor = '';
                        element.style.border = '';
                    }
                }
            }
            
            console.groupEnd();
            
            const message = `📊 Field Status:\n\n✅ Filled: ${filledCount}\n⚪ Empty: ${emptyCount}\n\nYou can convert to XML with partially filled fields.`;
            alert(message);
            
            return true; // Always return true to allow conversion
        }

        // Handle editable fields and real-time XML updates
        document.addEventListener('DOMContentLoaded', function() {
            const editableFields = document.querySelectorAll('.editable-field');
            
            editableFields.forEach(field => {
                // Store original placeholder
                const placeholder = field.getAttribute('data-placeholder');
                
                // Handle focus
                field.addEventListener('focus', function() {
                    if (this.textContent.trim() === '') {
                        this.textContent = '';
                    }
                    // Remove error highlighting on focus
                    this.style.backgroundColor = '';
                    this.style.border = '';
                });
                
                // Handle blur
                field.addEventListener('blur', function() {
                    if (this.textContent.trim() === '') {
                        this.textContent = '';
                    }
                });
                
                // Handle input
                field.addEventListener('input', function() {
                    // Remove placeholder styling when user types
                    if (this.textContent.trim() !== '') {
                        this.classList.remove('placeholder');
                    }
                    // Remove error highlighting when typing
                    this.style.backgroundColor = '';
                    this.style.border = '';
                });
            });
            
            // Add click handler for convert button
            document.getElementById('convertToXmlBtn').addEventListener('click', convertToXml);

            // Add loading indicators and auto-calculation to all editable fields
            editableFields.forEach(field => {
                // Add loading indicator
                const loadingSpinner = document.createElement('span');
                loadingSpinner.className = 'loading-spinner';
                loadingSpinner.innerHTML = '◐';
                loadingSpinner.style.cssText = `
                    display: none;
                    margin-left: 5px;
                    color: #333333;
                    font-size: 14px;
                    animation: spin 1s linear infinite;
                `;
                field.parentNode.appendChild(loadingSpinner);

                // Store the original input and blur handlers
                const originalInputHandler = field.oninput;
                const originalBlurHandler = field.onblur;

                // Enhanced input handler that combines original functionality with new features
                field.addEventListener('input', function(e) {
                    // Show loading spinner
                    loadingSpinner.style.display = 'inline';
                    
                    // Call original input handler if it exists
                    if (originalInputHandler) {
                        originalInputHandler.call(this, e);
                    }
                    
                    // Auto-calculate line item amounts if this is a quantity or rate field
                    const row = this.closest('tr');
                    if (row && row.parentNode.tagName === 'TBODY') {
                        // Check if this is a quantity or rate field (new column positions)
                        const isQuantityField = this.closest('td') === row.querySelector('td:nth-child(3)'); // Qty column
                        const isRateField = this.closest('td') === row.querySelector('td:nth-child(4)'); // Unit Price column
                        const isTotalPriceField = this.closest('td') === row.querySelector('td:nth-child(5)'); // Total Price column
                        
                        if (isQuantityField || isRateField) {
                            // Calculate amount for this line item
                            calculateLineItemAmount(row);
                            // Update all totals
                            updateAllTotals();
                        }
                        
                        // If Total Price field is manually edited, update subtotal
                        if (isTotalPriceField) {
                            updateAllTotals();
                        }
                    }

                    // Hide loading spinner after a short delay
                    setTimeout(() => {
                        loadingSpinner.style.display = 'none';
                    }, 500);
                });

                // Enhanced blur handler that combines original functionality with new features
                field.addEventListener('blur', function(e) {
                    // Call original blur handler if it exists
                    if (originalBlurHandler) {
                        originalBlurHandler.call(this, e);
                    }
                    
                    // Update totals when user finishes editing
                    const row = this.closest('tr');
                    if (row && row.parentNode.tagName === 'TBODY') {
                        updateAllTotals();
                    }
                    
                    // Also update totals if this is a tax, shipping, or other field
                    const cellText = this.closest('td')?.textContent || '';
                    if (cellText.includes('TAX:') || cellText.includes('SHIPPING:') || cellText.includes('OTHER:')) {
                        updateAllTotals();
                    }
                    
                    // Also update totals if this is a Total Price field
                    const isTotalPriceField = this.closest('td') === row?.querySelector('td:nth-child(5)');
                    if (isTotalPriceField) {
                        updateAllTotals();
                    }
                });
            });

            // Add CSS animation for loading spinner
            const style = document.createElement('style');
            style.textContent = `
                @keyframes spin {
                    0% { transform: rotate(0deg); }
                    100% { transform: rotate(360deg); }
                }
                .loading-spinner {
                    font-size: 12px;
                }
            `;
            document.head.appendChild(style);

            // Initialize totals on page load
            updateAllTotals();
        });
        
        // Generate XML from current form data using the centralized field mapping
        function generateXml() {
            console.group('🔧 XML Generation - Field Mapping');
            
            // Extract all field values using the centralized FIELD_MAPPING
            const fieldValues = {};
            for (const [fieldName, selector] of Object.entries(FIELD_MAPPING)) {
                const element = document.querySelector(selector);
                const value = element?.textContent.trim() || '';
                fieldValues[fieldName] = value;
                console.log(`${fieldName}: "${value}"`);
            }
            
            console.groupEnd();
            
            // Get line items (using the existing function)
            console.group('📋 Getting Line Items for XML');
            const lineItems = getLineItems();
            console.log('📄 Line Items HTML received:', lineItems);
            console.log('📏 Line Items length:', lineItems.length);
            console.groupEnd();
            
            // Create comprehensive NetSuite XML
            const xmlOutput = `<?xml version="1.0"?>
<!DOCTYPE pdf PUBLIC "-//big.faceless.org//report" "report-1.1.dtd">
<pdf>
<head>
    <link name="NotoSans" type="font" subtype="truetype" src="\${nsfont.NotoSans_Regular}" src-bold="\${nsfont.NotoSans_Bold}" src-italic="\${nsfont.NotoSans_Italic}" src-bolditalic="\${nsfont.NotoSans_BoldItalic}" bytes="2" />
    <macrolist>
        <macro id="nlheader">
            <table style="width: 100%;">
                <tr>
                    <td rowspan="3">
                        Company Name: ${fieldValues.companyName}<br />
                        Street Address: ${fieldValues.companyAddress}<br />
                        City, ST ZIP: ${fieldValues.companyCityState}<br />
                        Phone: ${fieldValues.companyPhone}<br />
                        Fax: ${fieldValues.companyFax}<br />
                        Website: ${fieldValues.companyWebsite}
                    </td>
                    <td align="right"><span class="title">Purchase Order</span></td>
                </tr>
                <tr>
                    <td align="right"><span class="number">#${fieldValues.poNumber}</span></td>
                </tr>
                <tr>
                    <td align="right">Date: ${fieldValues.poDate}</td>
                </tr>
            </table>
        </macro>
        <macro id="nlfooter">
            <table style="width: 100%;">
                <tr>
                    <td>
                        <barcode codetype="code128" showtext="true" value="${fieldValues.poNumber}"/>
                    </td>
                    <td align="right">
                        <pagenumber/> of <totalpages/>
                    </td>
                </tr>
            </table>
        </macro>
    </macrolist>
    <style>
        * {
            font-family: NotoSans, sans-serif;
        }
        table {
            font-size: 9pt;
            table-layout: fixed;
        }
        th {
            font-weight: bold;
            font-size: 8pt;
            vertical-align: middle;
            padding: 5px 6px 3px;
            background-color: #e3e3e3;
            color: #333333;
        }
        td {
            padding: 4px 6px;
        }
        table.header td {
            padding: 0;
            font-size: 10pt;
        }
        table.footer td {
            padding: 0;
            font-size: 8pt;
        }
        span.title {
            font-size: 28pt;
        }
        span.number {
            font-size: 16pt;
        }
        .addressheader {
            font-weight: bold;
            background-color: #f0f0f0;
            padding: 8px;
        }
        .totalboxtop, .totalboxmid, .totalboxbot {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 8px;
        }
    </style>
</head>
<body header="nlheader" header-height="10%" footer="nlfooter" footer-height="20pt" padding="0.5in 0.5in 0.5in 0.5in" size="Letter">
    <!-- Vendor and Ship To Section -->
    <table style="width: 100%; margin-bottom: 20px;">
        <tr>
            <td style="width: 50%; padding-right: 10px; vertical-align: top;">
                <table style="width: 100%; border: 1px solid #e5e7eb;">
                    <tr>
                        <td class="addressheader">VENDOR</td>
                    </tr>
                    <tr>
                        <td style="padding: 10px;">
                            Company Name: ${fieldValues.vendorCompany}<br />
                            Contact: ${fieldValues.vendorContact}<br />
                            Street Address: ${fieldValues.vendorAddress}<br />
                            City, State ZIP: ${fieldValues.vendorCityState}<br />
                            Phone: ${fieldValues.vendorPhone}<br />
                            Fax: ${fieldValues.vendorFax}
                        </td>
                    </tr>
                </table>
            </td>
            <td style="width: 50%; padding-left: 10px; vertical-align: top;">
                <table style="width: 100%; border: 1px solid #e5e7eb;">
                    <tr>
                        <td class="addressheader">SHIP TO</td>
                    </tr>
                    <tr>
                        <td style="padding: 10px;">
                            Name: ${fieldValues.shipToName}<br />
                            Company Name: ${fieldValues.shipToCompany}<br />
                            Street Address: ${fieldValues.shipToAddress}<br />
                            City, State ZIP: ${fieldValues.shipToCityState}<br />
                            Phone: ${fieldValues.shipToPhone}
                        </td>
                    </tr>
                </table>
            </td>
        </tr>
    </table>
    
    <!-- Shipping Details -->
    <table style="width: 100%; margin-bottom: 20px;">
        <tr>
            <td style="width: 25%; padding-right: 5px;">
                <table style="width: 100%; border: 1px solid #e5e7eb;">
                    <tr><td class="addressheader">REQUISITIONER</td></tr>
                    <tr><td style="padding: 8px; text-align: center;">${fieldValues.requisitioner}</td></tr>
                </table>
            </td>
            <td style="width: 25%; padding-right: 5px; padding-left: 5px;">
                <table style="width: 100%; border: 1px solid #e5e7eb;">
                    <tr><td class="addressheader">SHIP VIA</td></tr>
                    <tr><td style="padding: 8px; text-align: center;">${fieldValues.shipVia}</td></tr>
                </table>
            </td>
            <td style="width: 25%; padding-right: 5px; padding-left: 5px;">
                <table style="width: 100%; border: 1px solid #e5e7eb;">
                    <tr><td class="addressheader">F.O.B.</td></tr>
                    <tr><td style="padding: 8px; text-align: center;">${fieldValues.fob}</td></tr>
                </table>
            </td>
            <td style="width: 25%; padding-left: 5px;">
                <table style="width: 100%; border: 1px solid #e5e7eb;">
                    <tr><td class="addressheader">SHIPPING TERMS</td></tr>
                    <tr><td style="padding: 8px; text-align: center;">${fieldValues.shippingTerms}</td></tr>
                </table>
            </td>
        </tr>
    </table>
    
    <!-- Line Items Table -->
    <table style="width: 100%; border: 1px solid #e5e7eb; margin-bottom: 20px;">
        <tr>
            <th style="width: 10%;">Quantity</th>
            <th style="width: 40%;">Item</th>
            <th style="width: 10%;">Options</th>
            <th style="width: 20%;">Unit Price</th>
            <th style="width: 20%;">Total</th>
        </tr>
        ${lineItems}
    </table>
    
    <!-- Totals Section -->
    <table style="width: 100%; margin-bottom: 20px;">
        <tr>
            <td style="width: 70%;">
                <div style="margin-bottom: 10px;">
                    <strong>Comments:</strong><br />
                    ${fieldValues.comments}
                </div>
            </td>
            <td style="width: 30%;">
                <table style="width: 100%;">
                    <tr>
                        <td style="padding: 6px; border-bottom: 1px solid #e5e7eb; text-align: right;"><strong>Subtotal:</strong></td>
                        <td style="padding: 6px; border-bottom: 1px solid #e5e7eb; text-align: right;">$${fieldValues.subtotal}</td>
                    </tr>
                    <tr>
                        <td style="padding: 6px; border-bottom: 1px solid #e5e7eb; text-align: right;"><strong>Tax:</strong></td>
                        <td style="padding: 6px; border-bottom: 1px solid #e5e7eb; text-align: right;">$${fieldValues.tax}</td>
                    </tr>
                    <tr>
                        <td style="padding: 6px; border-bottom: 1px solid #e5e7eb; text-align: right;"><strong>Shipping:</strong></td>
                        <td style="padding: 6px; border-bottom: 1px solid #e5e7eb; text-align: right;">$${fieldValues.shipping}</td>
                    </tr>
                    <tr>
                        <td style="padding: 6px; border-bottom: 1px solid #e5e7eb; text-align: right;"><strong>Other:</strong></td>
                        <td style="padding: 6px; border-bottom: 1px solid #e5e7eb; text-align: right;">$${fieldValues.other}</td>
                    </tr>
                    <tr>
                        <td style="padding: 6px; background-color: #f8f9fa; border: 1px solid #dee2e6; text-align: right;"><strong>Total:</strong></td>
                        <td style="padding: 6px; background-color: #f8f9fa; border: 1px solid #dee2e6; text-align: right;"><strong>$${fieldValues.total}</strong></td>
                    </tr>
                </table>
            </td>
        </tr>
    </table>
    
    <!-- Footer Contact Info -->
                    <table style="width: 100%; border-top: 2px solid #333333; padding-top: 20px;">
        <tr>
            <td style="text-align: center; padding: 20px;">
                <strong>Contact Information:</strong><br />
                ${fieldValues.contactInfo}
            </td>
        </tr>
    </table>
</body>
</pdf>`;

            return xmlOutput;
        }
        
        // Get line items directly from the table structure (more reliable)
        function getLineItems() {
            console.group('📋 Line Items Generation - Direct Table Reading');
            let lineItemsHtml = '';
            
            const table = document.querySelector('table.itemtable');
            if (!table) {
                console.error('❌ Line item table not found!');
                console.groupEnd();
                return '';
            }
            
            // Use tbody rows only (skip thead)
            const tbodyRows = table.querySelectorAll('tbody tr');
            console.log(`📊 Total tbody rows found: ${tbodyRows.length}`);
            
            // Process all tbody rows
            tbodyRows.forEach((row, index) => {
                const cells = row.querySelectorAll('td');
                console.log(`🔍 Row ${index + 1}: Found ${cells.length} cells`);
                
                if (cells.length >= 5) {
                    // Extract values from the NEW column positions
                    const itemNumber = cells[0]?.querySelector('.editable-field')?.textContent.trim() || ''; // Column 1: Item#
                    const description = cells[1]?.querySelector('.editable-field')?.textContent.trim() || ''; // Column 2: Description
                    const qty = cells[2]?.querySelector('.editable-field')?.textContent.trim() || ''; // Column 3: Qty
                    const unitPrice = cells[3]?.querySelector('.editable-field')?.textContent.trim() || ''; // Column 4: Unit Price
                    const totalPrice = cells[4]?.querySelector('.editable-field')?.textContent.trim() || ''; // Column 5: Total Price
                    
                    console.log(`📋 Row ${index + 1} Data:`);
                    console.log(`  Item#: "${itemNumber}"`);
                    console.log(`  Description: "${description}"`);
                    console.log(`  Qty: "${qty}"`);
                    console.log(`  Unit Price: "${unitPrice}"`);
                    console.log(`  Total Price: "${totalPrice}"`);
                    
                    // Only add row if there's meaningful content
                    if (itemNumber || description || qty || unitPrice || totalPrice) {
                        lineItemsHtml += `
        <tr>
            <td style="padding: 6px; border-bottom: 1px solid #e5e7eb; text-align: center;">${itemNumber}</td>
            <td style="padding: 6px; border-bottom: 1px solid #e5e7eb;"><span class="itemname" style="font-weight: bold;">${description}</span></td>
            <td style="padding: 6px; border-bottom: 1px solid #e5e7eb; text-align: center;">${qty}</td>
            <td style="padding: 6px; border-bottom: 1px solid #e5e7eb; text-align: right;">$${unitPrice}</td>
            <td style="padding: 6px; border-bottom: 1px solid #e5e7eb; text-align: right;">$${totalPrice}</td>
        </tr>`;
                        console.log(`✅ Added line item ${index + 1} to XML`);
                    } else {
                        console.log(`⚪ Skipped empty row ${index + 1}`);
                    }
                } else {
                    console.warn(`⚠️ Row ${index + 1}: Insufficient cells (${cells.length})`);
                }
            });
            
            console.log(`📋 Total line items generated: ${lineItemsHtml.split('<tr>').length - 1}`);
            console.log(`📄 Final XML HTML:`, lineItemsHtml);
            console.groupEnd();
            return lineItemsHtml;
        }
        
        // Calculate subtotal from line items
        function calculateSubtotal() {
            console.group('🧮 CALCULATING SUBTOTAL');
            
            const totalCells = document.querySelectorAll('table.itemtable tbody tr td:last-child .editable-field');
            console.log(`📊 Found ${totalCells.length} total price cells`);
            
            let subtotal = 0;
            let rowCount = 0;
            
            totalCells.forEach((cell, index) => {
                const rawText = cell.textContent.trim();
                const value = parseFloat(rawText.replace(/[$,]/g, '')) || 0;
                subtotal += value;
                rowCount++;
                
                console.log(`  Row ${rowCount}: "${rawText}" → ${value} → Running total: ${subtotal}`);
            });
            
            const finalSubtotal = subtotal.toFixed(2);
            console.log(`🎯 FINAL SUBTOTAL: ${subtotal} → ${finalSubtotal}`);
            console.groupEnd();
            return finalSubtotal;
        }

        // Calculate total including tax, shipping, and other
        function calculateTotal() {
            console.group('🧮 CALCULATING TOTAL');
            
            const subtotal = parseFloat(calculateSubtotal()) || 0;
            console.log(`📊 Subtotal: ${subtotal}`);
            
            // Find tax, shipping, and other fields by looking for text content
            const allCells = document.querySelectorAll('td');
            let tax = 0, shipping = 0, other = 0;
            
            allCells.forEach(cell => {
                if (cell.textContent.includes('TAX:')) {
                    const taxField = cell.nextElementSibling?.querySelector('.editable-field');
                    if (taxField) {
                        const rawTax = taxField.textContent.trim();
                        tax = parseFloat(rawTax.replace(/[$,]/g, '')) || 0;
                        console.log(`💰 Tax: "${rawTax}" → ${tax}`);
                    }
                } else if (cell.textContent.includes('SHIPPING:')) {
                    const shippingField = cell.nextElementSibling?.querySelector('.editable-field');
                    if (shippingField) {
                        const rawShipping = shippingField.textContent.trim();
                        shipping = parseFloat(rawShipping.replace(/[$,]/g, '')) || 0;
                        console.log(`🚚 Shipping: "${rawShipping}" → ${shipping}`);
                    }
                } else if (cell.textContent.includes('OTHER:')) {
                    const otherField = cell.nextElementSibling?.querySelector('.editable-field');
                    if (otherField) {
                        const rawOther = otherField.textContent.trim();
                        other = parseFloat(rawOther.replace(/[$,]/g, '')) || 0;
                        console.log(`📝 Other: "${rawOther}" → ${other}`);
                    }
                }
            });
            
            const total = subtotal + tax + shipping + other;
            console.log(`🎯 CALCULATION: ${subtotal} + ${tax} + ${shipping} + ${other} = ${total}`);
            console.log(`🎯 FINAL TOTAL: ${total.toFixed(2)}`);
            console.groupEnd();
            return total.toFixed(2);
        }

        // Auto-calculate line item amounts when quantity or rate changes
        function calculateLineItemAmount(row) {
            console.group('🧮 CALCULATING LINE ITEM AMOUNT');
            
            const quantityField = row.querySelector('td:nth-child(3) .editable-field'); // Qty column
            const rateField = row.querySelector('td:nth-child(4) .editable-field'); // Unit Price column
            const amountField = row.querySelector('td:nth-child(5) .editable-field'); // Total Price column
            
            console.log(`🔍 Fields found:`);
            console.log(`  Quantity field: ${quantityField ? '✅' : '❌'}`);
            console.log(`  Rate field: ${rateField ? '✅' : '❌'}`);
            console.log(`  Amount field: ${amountField ? '✅' : '❌'}`);
            
            if (quantityField && rateField && amountField) {
                const rawQty = quantityField.textContent.trim();
                const rawRate = rateField.textContent.trim();
                
                const quantity = parseFloat(rawQty.replace(/[$,]/g, '')) || 0;
                const rate = parseFloat(rawRate.replace(/[$,]/g, '')) || 0;
                const amount = quantity * rate;
                
                console.log(`📊 Calculation: "${rawQty}" × "${rawRate}" = ${quantity} × ${rate} = ${amount}`);
                
                amountField.textContent = amount.toFixed(2);
                console.log(`✅ Updated amount field to: ${amount.toFixed(2)}`);
                console.groupEnd();
                return amount;
            } else {
                console.warn(`⚠️ Missing required fields for calculation`);
                console.groupEnd();
                return 0;
            }
        }

        // Update all totals when line items change
        function updateAllTotals() {
            console.group('🔄 UPDATING ALL TOTALS');
            
            // Update subtotal
            const allCells = document.querySelectorAll('td');
            let subtotalField = null, totalField = null;
            
            console.log(`🔍 Searching for total fields in ${allCells.length} cells...`);
            
            allCells.forEach((cell, index) => {
                const cellText = cell.textContent.trim();
                if (cellText.includes('SUBTOTAL:')) {
                    subtotalField = cell.nextElementSibling?.querySelector('.editable-field');
                    console.log(`✅ Found SUBTOTAL field at cell ${index}: "${cellText}"`);
                } else if (cellText.includes('TOTAL:')) {
                    totalField = cell.nextElementSibling?.querySelector('.editable-field');
                    console.log(`✅ Found TOTAL field at cell ${index}: "${cellText}"`);
                }
            });
            
            console.log(`📊 Fields found:`);
            console.log(`  Subtotal field: ${subtotalField ? '✅' : '❌'}`);
            console.log(`  Total field: ${totalField ? '✅' : '❌'}`);
            
            if (subtotalField) {
                const oldSubtotal = subtotalField.textContent.trim();
                const newSubtotal = calculateSubtotal();
                subtotalField.textContent = newSubtotal;
                console.log(`🔄 Updated subtotal: "${oldSubtotal}" → "${newSubtotal}"`);
            } else {
                console.warn(`⚠️ Subtotal field not found!`);
            }
            
            if (totalField) {
                const oldTotal = totalField.textContent.trim();
                const newTotal = calculateTotal();
                totalField.textContent = newTotal;
                console.log(`🔄 Updated total: "${oldTotal}" → "${newTotal}"`);
            } else {
                console.warn(`⚠️ Total field not found!`);
            }
            
            console.groupEnd();
        }
        
        // Comprehensive field mapping test using the centralized FIELD_MAPPING
        function testFieldMapping() {
            console.group('🧪 FIELD MAPPING TEST');
            
            const testResults = {};
            let successCount = 0;
            let errorCount = 0;
            
            // Test each field mapping
            for (const [fieldName, selector] of Object.entries(FIELD_MAPPING)) {
                const element = document.querySelector(selector);
                const value = element?.textContent.trim() || '';
                const found = !!element;
                
                testResults[fieldName] = {
                    selector: selector,
                    found: found,
                    value: value,
                    element: element
                };
                
                if (found) {
                    successCount++;
                    console.log(`✅ ${fieldName}: Found at "${selector}" = "${value}"`);
                } else {
                    errorCount++;
                    console.warn(`❌ ${fieldName}: NOT FOUND at "${selector}"`);
                }
            }
            
            console.groupEnd();
            
            // Create detailed test report
            const report = `🧪 COMPREHENSIVE FIELD MAPPING TEST REPORT

📊 SUMMARY:
✅ Successfully Mapped: ${successCount}
❌ Mapping Errors: ${errorCount}
📋 Total Fields: ${Object.keys(FIELD_MAPPING).length}

🔍 DETAILED RESULTS:

${Object.entries(testResults).map(([fieldName, result]) => {
    const status = result.found ? '✅' : '❌';
    const value = result.found ? `"${result.value}"` : 'NOT FOUND';
    return `${status} ${fieldName}: ${value}`;
}).join('\n')}

📍 SELECTOR ANALYSIS:
${errorCount > 0 ? 
    Object.entries(testResults).filter(([_, result]) => !result.found).map(([fieldName, result]) => 
        `❌ ${fieldName}: ${result.selector}`
    ).join('\n') : 
    '🎉 All fields are properly mapped!'
}

💡 RECOMMENDATIONS:
${errorCount > 0 ? 
    `- Review selectors for ${errorCount} unmapped fields
- Check HTML structure for missing elements
- Verify CSS selectors match actual DOM structure` : 
    '🎉 All fields are properly mapped!'
}`;
            
            // Show results in modal
            showTestResultsModal(report);
        }
        
        // Function to test line item structure specifically
        function testLineItemStructure() {
            console.group('📋 LINE ITEM STRUCTURE TEST');
            
            const lineItemTable = document.querySelector('table.itemtable');
            if (!lineItemTable) {
                console.error('❌ Line item table not found!');
                alert('❌ Line item table not found! Check HTML structure.');
                return;
            }
            
            console.log('✅ Found line item table:', lineItemTable);
            
            const rows = lineItemTable.querySelectorAll('tr');
            console.log(`📊 Total rows: ${rows.length}`);
            
            // Test each row structure
            rows.forEach((row, rowIndex) => {
                console.group(`Row ${rowIndex + 1}`);
                
                const cells = row.querySelectorAll('td, th');
                console.log(`Cells: ${cells.length}`);
                
                cells.forEach((cell, cellIndex) => {
                    const editableFields = cell.querySelectorAll('.editable-field');
                    const colspan = cell.getAttribute('colspan') || '1';
                    
                    console.log(`  Cell ${cellIndex + 1}: colspan=${colspan}, editable fields: ${editableFields.length}`);
                    
                    editableFields.forEach((field, fieldIndex) => {
                        const value = field.textContent.trim() || '(empty)';
                        console.log(`    Field ${fieldIndex + 1}: "${value}"`);
                    });
                });
                
                console.groupEnd();
            });
            
            // Test specific line item mappings
            console.group('🔍 LINE ITEM FIELD MAPPING TEST');
            
            for (let i = 1; i <= 5; i++) {
                const qtySelector = FIELD_MAPPING[`lineItem${i}Qty`];
                const itemSelector = FIELD_MAPPING[`lineItem${i}Item`];
                const descSelector = FIELD_MAPPING[`lineItem${i}Desc`];
                const optionsSelector = FIELD_MAPPING[`lineItem${i}Options`];
                const rateSelector = FIELD_MAPPING[`lineItem${i}Rate`];
                const amountSelector = FIELD_MAPPING[`lineItem${i}Amount`];
                
                const qtyElement = document.querySelector(qtySelector);
                const itemElement = document.querySelector(itemSelector);
                const descElement = document.querySelector(descSelector);
                const optionsElement = document.querySelector(optionsSelector);
                const rateElement = document.querySelector(rateSelector);
                const amountElement = document.querySelector(amountSelector);
                
                console.log(`Line Item ${i}:`);
                console.log(`  Qty: ${qtyElement ? '✅' : '❌'} "${qtyElement?.textContent.trim() || ''}"`);
                console.log(`  Item: ${itemElement ? '✅' : '❌'} "${itemElement?.textContent.trim() || ''}"`);
                console.log(`  Desc: ${descElement ? '✅' : '❌'} "${descElement?.textContent.trim() || ''}"`);
                console.log(`  Options: ${optionsElement ? '✅' : '❌'} "${optionsElement?.textContent.trim() || ''}"`);
                console.log(`  Rate: ${rateElement ? '✅' : '❌'} "${rateElement?.textContent.trim() || ''}"`);
                console.log(`  Amount: ${amountElement ? '✅' : '❌'} "${amountElement?.textContent.trim() || ''}"`);
            }
            
            console.groupEnd();
            console.groupEnd();
            
            // Generate test report
            const report = `📋 LINE ITEM STRUCTURE TEST REPORT

📊 TABLE STRUCTURE:
✅ Table found: ${!!lineItemTable}
📊 Total rows: ${rows.length}

🔍 ROW ANALYSIS:
${Array.from(rows).map((row, index) => {
    const cells = row.querySelectorAll('td, th');
    const editableFields = row.querySelectorAll('.editable-field');
    return `Row ${index + 1}: ${cells.length} cells, ${editableFields.length} editable fields`;
}).join('\n')}

🎯 FIELD MAPPING STATUS:
${Array.from({length: 5}, (_, i) => {
    const num = i + 1;
    const qty = document.querySelector(FIELD_MAPPING[`lineItem${num}Qty`]) ? '✅' : '❌';
    const item = document.querySelector(FIELD_MAPPING[`lineItem${num}Item`]) ? '✅' : '✅';
    const desc = document.querySelector(FIELD_MAPPING[`lineItem${num}Desc`]) ? '✅' : '❌';
    const options = document.querySelector(FIELD_MAPPING[`lineItem${num}Options`]) ? '✅' : '❌';
    const rate = document.querySelector(FIELD_MAPPING[`lineItem${num}Rate`]) ? '✅' : '❌';
    const amount = document.querySelector(FIELD_MAPPING[`lineItem${num}Amount`]) ? '✅' : '❌';
    
    return `Line Item ${num}: Qty:${qty} Item:${item} Desc:${desc} Options:${options} Rate:${rate} Amount:${amount}`;
}).join('\n')}

💡 RECOMMENDATIONS:
${rows.length < 6 ? '⚠️ Expected at least 6 rows (header + 5 data rows)' : '✅ Row count looks good'}
${Array.from(rows).some(row => row.querySelectorAll('.editable-field').length === 0) ? '⚠️ Some rows have no editable fields' : '✅ All rows have editable fields'}`;
            
            showTestResultsModal(report);
        }

        // Function to highlight all fields visually for testing
        function highlightAllFields() {
            console.group('🔍 VISUAL FIELD HIGHLIGHTING');
            
            // Clear any existing highlights
            document.querySelectorAll('.editable-field').forEach(field => {
                field.style.backgroundColor = '';
                field.style.border = '';
                field.style.boxShadow = '';
            });
            
            let highlightCount = 0;
            
            // Highlight each field with a different color based on section
            for (const [fieldName, selector] of Object.entries(FIELD_MAPPING)) {
                const element = document.querySelector(selector);
                if (element) {
                    highlightCount++;
                    
                    // Color code by section
                    let color = '#e3f2fd'; // Default blue
                    if (fieldName.includes('company')) color = '#e8f5e8'; // Company info - green
                    else if (fieldName.includes('vendor')) color = '#fff3e0'; // Vendor - orange
                    else if (fieldName.includes('shipTo')) color = '#f3e5f5'; // Ship to - purple
                    else if (fieldName.includes('lineItem')) color = '#fce4ec'; // Line items - pink
                    else if (fieldName.includes('total') || fieldName.includes('subtotal') || fieldName.includes('tax') || fieldName.includes('shipping')) color = '#e0f2f1'; // Totals - teal
                    else if (fieldName.includes('comment')) color = '#f1f8e9'; // Comments - light green
                    else if (fieldName.includes('contact')) color = '#fff8e1'; // Contact - yellow
                    
                    element.style.backgroundColor = color;
                    element.style.border = '2px solid #2196f3';
                    element.style.boxShadow = '0 0 8px rgba(33, 150, 243, 0.3)';
                    
                    // Add field name label
                    const label = document.createElement('div');
                    label.textContent = fieldName;
                    label.style.cssText = `
                        position: absolute;
                        background: #2196f3;
                        color: white;
                        padding: 2px 6px;
                        border-radius: 3px;
                        font-size: 10px;
                        font-weight: bold;
                        z-index: 1000;
                        pointer-events: none;
                    `;
                    
                    // Position label above the field
                    const rect = element.getBoundingClientRect();
                    label.style.left = rect.left + 'px';
                    label.style.top = (rect.top - 20) + 'px';
                    
                    document.body.appendChild(label);
                    
                    // Remove label after 5 seconds
                    setTimeout(() => label.remove(), 5000);
                    
                    console.log(`🔍 Highlighted: ${fieldName} at ${selector}`);
                }
            }
            
            console.log(`🎯 Total fields highlighted: ${highlightCount}`);
            console.groupEnd();
            
            // Auto-remove highlights after 5 seconds
            setTimeout(() => {
                document.querySelectorAll('.editable-field').forEach(field => {
                    field.style.backgroundColor = '';
                    field.style.border = '';
                    field.style.boxShadow = '';
                });
                console.log('🧹 Auto-cleared all field highlights');
            }, 5000);
            
            alert(`🔍 Field Highlighting Complete!\n\n✅ Highlighted ${highlightCount} fields\n🎨 Color-coded by section\n⏰ Auto-clear in 5 seconds\n\nCheck the page to see field locations!`);
        }

        // Function to show test results in a modal with copy button
        function showTestResultsModal(results) {
            // Create modal HTML
            const modalHTML = `
                <div id="testResultsModal" style="
                    display: block;
                    position: fixed;
                    z-index: 1000;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    background-color: rgba(0,0,0,0.5);
                ">
                    <div style="
                        background-color: white;
                        margin: 5% auto;
                        padding: 20px;
                        border-radius: 8px;
                        width: 90%;
                        max-width: 600px;
                        max-height: 80vh;
                        overflow-y: auto;
                    ">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h2 style="margin: 0; color: #333;">🧪 Field Mapping Test Results</h2>
                            <button onclick="closeTestResultsModal()" style="
                                background: #dc3545;
                                color: white;
                                border: none;
                                padding: 8px 16px;
                                border-radius: 4px;
                                cursor: pointer;
                            ">✕ Close</button>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <button onclick="copyTestResults()" style="
                                background: #28a745;
                                color: white;
                                border: none;
                                padding: 8px 16px;
                                border-radius: 4px;
                                cursor: pointer;
                                margin-right: 10px;
                            ">📋 Copy Results</button>
                        </div>
                        
                        <div style="
                            background: #f8f9fa;
                            border: 1px solid #dee2e6;
                            border-radius: 4px;
                            padding: 15px;
                            font-family: 'Courier New', monospace;
                            font-size: 12px;
                            white-space: pre-wrap;
                            overflow-x: auto;
                            max-height: 400px;
                            overflow-y: auto;
                        " id="testResultsOutput">${results}</div>
                    </div>
                </div>
            `;
            
            // Add modal to page
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }
        
        // Function to close test results modal
        function closeTestResultsModal() {
            const modal = document.getElementById('testResultsModal');
            if (modal) {
                modal.remove();
            }
        }
        
        // Function to copy test results to clipboard
        async function copyTestResults() {
            const resultsText = document.getElementById('testResultsOutput').textContent;
            try {
                await navigator.clipboard.writeText(resultsText);
                alert('Test results copied to clipboard!');
            } catch (err) {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = resultsText;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('Test results copied to clipboard!');
            }
        }
        
        // Convert HTML to NetSuite XML - now allows partial field completion
        function convertToXml() {
            console.log('Starting XML conversion...');
            
            // Show field status before conversion
            validateAllFields();
            
            const xmlContent = generateXml();
            
            // Verify XML structure
            if (!xmlContent.includes('<?xml version="1.0"?>') || 
                !xmlContent.includes('<pdf>') ||
                !xmlContent.includes('</pdf>')) {
                console.error('Invalid XML structure generated');
                alert('Error generating XML: Invalid structure');
                return;
            }

            console.log('XML conversion successful');
            
            // Display XML in modal
            document.getElementById('xmlOutput').textContent = xmlContent;
            document.getElementById('xmlModal').style.display = 'block';
        }
        
        // Close XML modal
        function closeXmlModal() {
            document.getElementById('xmlModal').style.display = 'none';
        }
        
        // Copy XML to clipboard
        async function copyXmlToClipboard() {
            const xmlContent = document.getElementById('xmlOutput').textContent;
            try {
                await navigator.clipboard.writeText(xmlContent);
                alert('XML copied to clipboard!');
            } catch (err) {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = xmlContent;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('XML copied to clipboard!');
            }
        }
        
        // Download XML file
        function downloadXml() {
            const xmlContent = document.getElementById('xmlOutput').textContent;
            const blob = new Blob([xmlContent], { type: 'application/xml' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'purchase-order-netsuite.xml';
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }
        
        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('xmlModal');
            if (event.target === modal) {
                closeXmlModal();
            }
        }

        // Test XML generation to ensure all fields are properly included
        function testXmlGeneration() {
            console.group('🧪 XML GENERATION TEST');
            
            // Generate XML
            const xmlContent = generateXml();
            
            // Check if XML contains all expected field values
            const fieldValues = {};
            for (const [fieldName, selector] of Object.entries(FIELD_MAPPING)) {
                const element = document.querySelector(selector);
                const value = element?.textContent.trim() || '';
                fieldValues[fieldName] = value;
            }
            
            // Test if each field value appears in the XML
            const testResults = {};
            let successCount = 0;
            let errorCount = 0;
            
            for (const [fieldName, value] of Object.entries(fieldValues)) {
                if (value && xmlContent.includes(value)) {
                    testResults[fieldName] = { status: '✅', value: value, found: true };
                    successCount++;
                } else if (!value) {
                    testResults[fieldName] = { status: '⚪', value: '(empty)', found: 'N/A' };
                } else {
                    testResults[fieldName] = { status: '❌', value: value, found: false };
                    errorCount++;
                }
            }
            
            console.log('📊 XML Generation Test Results:');
            console.log(`✅ Successfully included: ${successCount}`);
            console.log(`❌ Missing from XML: ${errorCount}`);
            console.log(`⚪ Empty fields: ${Object.keys(fieldValues).length - successCount - errorCount}`);
            
            // Generate detailed report
            const report = `🧪 XML GENERATION TEST REPORT

📊 SUMMARY:
✅ Successfully included in XML: ${successCount}
❌ Missing from XML: ${errorCount}
⚪ Empty fields: ${Object.keys(fieldValues).length - successCount - errorCount}
📋 Total fields: ${Object.keys(fieldValues).length}

🔍 DETAILED RESULTS:
${Object.entries(testResults).map(([fieldName, result]) => {
    if (result.found === 'N/A') {
        return `${result.status} ${fieldName}: ${result.value}`;
    } else if (result.found) {
        return `${result.status} ${fieldName}: "${result.value}" (found in XML)`;
    } else {
        return `${result.status} ${fieldName}: "${result.value}" (MISSING from XML)`;
    }
}).join('\n')}

💡 RECOMMENDATIONS:
${errorCount > 0 ? 
    `- ${errorCount} field values are missing from the generated XML
- Check XML template for missing field references
- Verify field mapping selectors are correct` : 
    '🎉 All filled fields are properly included in the XML!'
}

📄 XML PREVIEW (first 500 chars):
${xmlContent.substring(0, 500)}...`;
            
            showTestResultsModal(report);
            console.groupEnd();
        }

        // Generate PDF from current form data and allow download
        function generateAndDownloadPDF() {
            console.group('📄 PDF Generation and Download');
            
            // Extract all field values using the centralized FIELD_MAPPING
            const fieldValues = {};
            for (const [fieldName, selector] of Object.entries(FIELD_MAPPING)) {
                const element = document.querySelector(selector);
                const value = element?.textContent.trim() || '';
                fieldValues[fieldName] = value;
                console.log(`${fieldName}: "${value}"`);
            }
            
            // Get line items
            const lineItems = getLineItems();
            
            // Create HTML content for PDF
            const pdfHtml = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Purchase Order - ${fieldValues.poNumber || 'PO-001'}</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            font-size: 12px;
            line-height: 1.4;
        }
        .header {
                            border-bottom: 2px solid #333333;
            padding-bottom: 20px;
            margin-bottom: 30px;
        }
        .company-info {
            float: left;
            width: 60%;
        }
        .po-details {
            float: right;
            width: 35%;
            text-align: right;
        }
        .clear {
            clear: both;
        }
        .section {
            margin-bottom: 25px;
        }
        .section-title {
            background-color: #f3f4f6;
            padding: 8px 12px;
            font-weight: bold;
            border: 1px solid #d1d5db;
            margin-bottom: 10px;
        }
        .vendor-ship-to {
            display: flex;
            gap: 20px;
        }
        .vendor-ship-to > div {
            flex: 1;
        }
        .shipping-details {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
        }
        .shipping-details > div {
            flex: 1;
            text-align: center;
        }
        .line-items-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 25px;
        }
        .line-items-table th {
            background-color: #f3f4f6;
            padding: 10px;
            border: 1px solid #d1d5db;
            text-align: left;
            font-weight: bold;
        }
        .line-items-table td {
            padding: 10px;
            border: 1px solid #d1d5db;
        }
        .totals-section {
            display: flex;
            gap: 20px;
        }
        .comments {
            flex: 2;
        }
        .totals {
            flex: 1;
        }
        .totals table {
            width: 100%;
        }
        .totals td {
            padding: 8px;
            border-bottom: 1px solid #e5e7eb;
        }
        .total-row {
            background-color: #f8f9fa;
            font-weight: bold;
            border: 1px solid #dee2e6;
        }
        .footer {
                            border-top: 2px solid #333333;
            padding-top: 20px;
            text-align: center;
            margin-top: 30px;
        }
        @media print {
            body { margin: 0; }
            .no-print { display: none; }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="company-info">
            <h2>${fieldValues.companyName || 'Company Name'}</h2>
            <p>${fieldValues.companyAddress || 'Company Address'}</p>
            <p>${fieldValues.companyCityState || 'City, State ZIP'}</p>
            <p>Phone: ${fieldValues.companyPhone || 'Phone'}</p>
            <p>Fax: ${fieldValues.companyFax || 'Fax'}</p>
            <p>Website: ${fieldValues.companyWebsite || 'Website'}</p>
        </div>
        <div class="po-details">
            <h1>PURCHASE ORDER</h1>
            <h3>#${fieldValues.poNumber || 'PO-001'}</h3>
            <p>Date: ${fieldValues.poDate || 'Date'}</p>
        </div>
        <div class="clear"></div>
    </div>

    <div class="section">
        <div class="vendor-ship-to">
            <div>
                <div class="section-title">VENDOR</div>
                <p><strong>Company:</strong> ${fieldValues.vendorCompany || 'Vendor Company'}</p>
                <p><strong>Contact:</strong> ${fieldValues.vendorContact || 'Vendor Contact'}</p>
                <p><strong>Address:</strong> ${fieldValues.vendorAddress || 'Vendor Address'}</p>
                <p><strong>City, State ZIP:</strong> ${fieldValues.vendorCityState || 'Vendor City State'}</p>
                <p><strong>Phone:</strong> ${fieldValues.vendorPhone || 'Vendor Phone'}</p>
                <p><strong>Fax:</strong> ${fieldValues.vendorFax || 'Vendor Fax'}</p>
            </div>
            <div>
                <div class="section-title">SHIP TO</div>
                <p><strong>Name:</strong> ${fieldValues.shipToName || 'Ship To Name'}</p>
                <p><strong>Company:</strong> ${fieldValues.shipToCompany || 'Ship To Company'}</p>
                <p><strong>Address:</strong> ${fieldValues.shipToAddress || 'Ship To Address'}</p>
                <p><strong>City, State ZIP:</strong> ${fieldValues.shipToCityState || 'Ship To City State'}</p>
                <p><strong>Phone:</strong> ${fieldValues.shipToPhone || 'Ship To Phone'}</p>
            </div>
        </div>
    </div>

    <div class="section">
        <div class="shipping-details">
            <div>
                <div class="section-title">REQUISITIONER</div>
                <p>${fieldValues.requisitioner || 'Requisitioner'}</p>
            </div>
            <div>
                <div class="section-title">SHIP VIA</div>
                <p>${fieldValues.shipVia || 'Ship Via'}</p>
            </div>
            <div>
                <div class="section-title">F.O.B.</div>
                <p>${fieldValues.fob || 'FOB'}</p>
            </div>
            <div>
                <div class="section-title">SHIPPING TERMS</div>
                <p>${fieldValues.shippingTerms || 'Shipping Terms'}</p>
            </div>
        </div>
    </div>

    <div class="section">
        <div class="section-title">LINE ITEMS</div>
        <table class="line-items-table">
            <thead>
                <tr>
                    <th style="width: 10%;">Quantity</th>
                    <th style="width: 40%;">Item</th>
                    <th style="width: 10%;">Options</th>
                    <th style="width: 20%;">Unit Price</th>
                    <th style="width: 20%;">Total</th>
                </tr>
            </thead>
            <tbody>
                ${lineItems}
            </tbody>
        </table>
    </div>

    <div class="section">
        <div class="totals-section">
            <div class="comments">
                <div class="section-title">COMMENTS OR SPECIAL INSTRUCTIONS</div>
                <p>${fieldValues.comments || 'No comments'}</p>
            </div>
            <div class="totals">
                <table>
                    <tr>
                        <td><strong>Subtotal:</strong></td>
                        <td style="text-align: right;">$${fieldValues.subtotal || '0.00'}</td>
                    </tr>
                    <tr>
                        <td><strong>Tax:</strong></td>
                        <td style="text-align: right;">$${fieldValues.tax || '0.00'}</td>
                    </tr>
                    <tr>
                        <td><strong>Shipping:</strong></td>
                        <td style="text-align: right;">$${fieldValues.shipping || '0.00'}</td>
                    </tr>
                    <tr>
                        <td><strong>Other:</strong></td>
                        <td style="text-align: right;">$${fieldValues.other || '0.00'}</td>
                    </tr>
                    <tr class="total-row">
                        <td><strong>TOTAL:</strong></td>
                        <td style="text-align: right;"><strong>$${fieldValues.total || '0.00'}</strong></td>
                    </tr>
                </table>
            </div>
        </div>
    </div>

    <div class="footer">
        <div class="section-title">CONTACT INFORMATION</div>
        <p>${fieldValues.contactInfo || 'Contact Information'}</p>
    </div>
</body>
</html>`;

            // Create a blob with the HTML content
            const blob = new Blob([pdfHtml], { type: 'text/html' });
            
            // Create download link
            const downloadLink = document.createElement('a');
            downloadLink.href = URL.createObjectURL(blob);
            downloadLink.download = `Purchase_Order_${fieldValues.poNumber || 'PO-001'}_${fieldValues.poDate || new Date().toISOString().split('T')[0]}.html`;
            
            // Trigger download
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
            
            // Clean up
            URL.revokeObjectURL(downloadLink.href);
            
            console.log('📄 PDF-ready HTML generated and downloaded');
            console.groupEnd();
            
            alert(`📄 Purchase Order downloaded!\n\nFile: ${downloadLink.download}\n\nNote: This is an HTML file that can be opened in any browser and printed to PDF.`);
        }

        // Generate advanced PDF using jsPDF library - NOW USING XML DATA!
        function generateAdvancedPDF() {
            console.group('📄 Advanced PDF Generation - Using XML Data');
            
            // Check if jsPDF is available
            if (typeof window.jspdf === 'undefined') {
                alert('❌ jsPDF library not loaded. Please refresh the page and try again.');
                console.error('jsPDF library not available');
                console.groupEnd();
                return;
            }
            
            // Extract all field values using the centralized FIELD_MAPPING
            const fieldValues = {};
            for (const [fieldName, selector] of Object.entries(FIELD_MAPPING)) {
                const element = document.querySelector(selector);
                const value = element?.textContent.trim() || '';
                fieldValues[fieldName] = value;
                console.log(`${fieldName}: "${value}"`);
            }
            
            // Get line items from XML generation (much more reliable!)
            const lineItems = getLineItems();
            console.log('📄 PDF Generation - Line Items from XML:', lineItems);
            
            try {
                // Create new PDF document
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');
                
                // Set font
                doc.setFont('helvetica');
                
                // Header section
                doc.setFontSize(20);
                doc.text('PURCHASE ORDER', 105, 20, { align: 'center' });
                
                // Company info (left side)
                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.text(fieldValues.companyName || 'Company Name', 20, 35);
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(10);
                doc.text(fieldValues.companyAddress || 'Company Address', 20, 42);
                doc.text(fieldValues.companyCityState || 'City, State ZIP', 20, 49);
                doc.text(`Phone: ${fieldValues.companyPhone || 'Phone'}`, 20, 56);
                doc.text(`Fax: ${fieldValues.companyFax || 'Fax'}`, 20, 63);
                doc.text(`Website: ${fieldValues.companyWebsite || 'Website'}`, 20, 70);
                
                // PO details (right side)
                doc.setFont('helvetica', 'bold');
                doc.text(`PO #: ${fieldValues.poNumber || 'PO-001'}`, 150, 35);
                doc.setFont('helvetica', 'normal');
                doc.text(`Date: ${fieldValues.poDate || 'Date'}`, 150, 42);
                
                // Vendor and Ship To section
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(12);
                doc.text('VENDOR', 20, 85);
                doc.text('SHIP TO', 110, 85);
                
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(10);
                doc.text(`Company: ${fieldValues.vendorCompany || 'Vendor Company'}`, 20, 95);
                doc.text(`Contact: ${fieldValues.vendorContact || 'Vendor Contact'}`, 20, 102);
                doc.text(`Address: ${fieldValues.vendorAddress || 'Vendor Address'}`, 20, 109);
                doc.text(`City, State ZIP: ${fieldValues.vendorCityState || 'Vendor City State'}`, 20, 116);
                doc.text(`Phone: ${fieldValues.vendorPhone || 'Vendor Phone'}`, 20, 123);
                doc.text(`Fax: ${fieldValues.vendorFax || 'Vendor Fax'}`, 20, 130);
                
                doc.text(`Name: ${fieldValues.shipToName || 'Ship To Name'}`, 110, 95);
                doc.text(`Company: ${fieldValues.shipToCompany || 'Ship To Company'}`, 110, 102);
                doc.text(`Address: ${fieldValues.shipToAddress || 'Ship To Address'}`, 110, 109);
                doc.text(`City, State ZIP: ${fieldValues.shipToCityState || 'Ship To City State'}`, 110, 116);
                doc.text(`Phone: ${fieldValues.shipToPhone || 'Ship To Phone'}`, 110, 123);
                
                // Shipping details
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(11);
                doc.text('REQUISITIONER', 20, 145);
                doc.text('SHIP VIA', 60, 145);
                doc.text('F.O.B.', 100, 145);
                doc.text('SHIPPING TERMS', 140, 145);
                
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(10);
                doc.text(fieldValues.requisitioner || 'Requisitioner', 20, 155, { align: 'center' });
                doc.text(fieldValues.shipVia || 'Ship Via', 60, 155, { align: 'center' });
                doc.text(fieldValues.fob || 'FOB', 100, 155, { align: 'center' });
                doc.text(fieldValues.shippingTerms || 'Shipping Terms', 140, 155, { align: 'center' });
                
                // Line items table
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(11);
                doc.text('LINE ITEMS', 20, 175);
                
                // Table headers
                doc.setFontSize(9);
                doc.text('Qty', 20, 185);
                doc.text('Item', 35, 185);
                doc.text('Options', 80, 185);
                doc.text('Rate', 120, 185);
                doc.text('Amount', 150, 185);
                
                // Table content - NOW USING XML DATA INSTEAD OF HTML PARSING!
                doc.setFont('helvetica', 'normal');
                let yPos = 195;
                
                // Parse line items from the XML-style HTML (much more reliable!)
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = lineItems;
                const rows = tempDiv.querySelectorAll('tr');
                
                console.log(`📄 PDF Processing: Found ${rows.length} line item rows from XML data`);
                
                rows.forEach((row, index) => {
                    if (yPos > 250) {
                        doc.addPage();
                        yPos = 20;
                    }
                    
                    const cells = row.querySelectorAll('td');
                    if (cells.length >= 5) {
                        const qty = cells[0]?.textContent?.trim() || '';
                        const itemCell = cells[1]?.textContent?.trim() || '';
                        const options = cells[2]?.textContent?.trim() || '';
                        const rate = cells[3]?.textContent?.trim() || '';
                        const amount = cells[4]?.textContent?.trim() || '';
                        
                        // Split item and description (they're combined in one cell)
                        const itemParts = itemCell.split('\n');
                        const item = itemParts[0] || '';
                        const desc = itemParts[1] || '';
                        
                        console.log(`📄 PDF Row ${index + 1}: Qty="${qty}", Item="${item}", Desc="${desc}", Options="${options}", Rate="${rate}", Amount="${amount}"`);
                        
                        if (qty || item || rate || amount) {
                            doc.text(qty, 20, yPos);
                            // Combine item and description for display
                            const itemDisplay = desc ? `${item} - ${desc}` : item;
                            doc.text(itemDisplay.substring(0, 40), 35, yPos);
                            doc.text(options.substring(0, 25), 80, yPos);
                            doc.text(rate, 120, yPos);
                            doc.text(amount, 150, yPos);
                            yPos += 8;
                        }
                    }
                });
                
                // Totals section
                yPos = Math.max(yPos + 10, 270);
                if (yPos > 250) {
                    doc.addPage();
                    yPos = 20;
                }
                
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(11);
                doc.text('TOTALS', 20, yPos);
                
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(10);
                yPos += 15;
                doc.text('Subtotal:', 120, yPos);
                doc.text(`$${fieldValues.subtotal || '0.00'}`, 170, yPos);
                yPos += 8;
                doc.text('Tax:', 120, yPos);
                doc.text(`$${fieldValues.tax || '0.00'}`, 170, yPos);
                yPos += 8;
                doc.text('Shipping:', 120, yPos);
                doc.text(`$${fieldValues.shipping || '0.00'}`, 170, yPos);
                yPos += 8;
                doc.text('Other:', 120, yPos);
                doc.text(`$${fieldValues.other || '0.00'}`, 170, yPos);
                yPos += 8;
                doc.setFont('helvetica', 'bold');
                doc.text('TOTAL:', 120, yPos);
                doc.text(`$${fieldValues.total || '0.00'}`, 170, yPos);
                
                // Comments
                yPos += 15;
                doc.setFont('helvetica', 'bold');
                doc.text('COMMENTS:', 20, yPos);
                doc.setFont('helvetica', 'normal');
                yPos += 8;
                const comments = fieldValues.comments || 'No comments';
                const commentsLines = doc.splitTextToSize(comments, 150);
                doc.text(commentsLines, 20, yPos);
                
                // Footer
                yPos += commentsLines.length * 5 + 10;
                if (yPos > 250) {
                    doc.addPage();
                    yPos = 20;
                }
                
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(11);
                doc.text('CONTACT INFORMATION', 105, yPos, { align: 'center' });
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(10);
                yPos += 8;
                doc.text(fieldValues.contactInfo || 'Contact Information', 105, yPos, { align: 'center' });
                
                // Save the PDF
                const fileName = `Purchase_Order_${fieldValues.poNumber || 'PO-001'}_${fieldValues.poDate || new Date().toISOString().split('T')[0]}.pdf`;
                doc.save(fileName);
                
                console.log('📄 Advanced PDF generated and downloaded:', fileName);
                console.groupEnd();
                
                alert(`📄 Advanced PDF generated successfully!\n\nFile: ${fileName}\n\nThis is a proper PDF file with professional formatting.`);
                
            } catch (error) {
                console.error('Error generating PDF:', error);
                alert('❌ Error generating PDF. Please try the HTML download option instead.');
                console.groupEnd();
            }
        }

        // Debug function to check line item structure specifically
        function debugLineItems() {
            console.group('🐛 LINE ITEM DEBUG');
            
            const table = document.querySelector('table.itemtable');
            if (!table) {
                console.error('❌ Table with class "itemtable" not found!');
                console.groupEnd();
                return;
            }
            
            console.log('✅ Found table.itemtable:', table);
            
            const rows = table.querySelectorAll('tr');
            const tbodyRows = table.querySelectorAll('tbody tr');
            console.log(`📊 Total rows (including header): ${rows.length}`);
            console.log(`📊 Data rows (tbody only): ${tbodyRows.length}`);
            
            // Check if there's a thead
            const thead = table.querySelector('thead');
            if (thead) {
                console.log('📋 Found thead section');
                const headerRows = thead.querySelectorAll('tr');
                headerRows.forEach((row, index) => {
                    console.group(`Header Row ${index + 1}`);
                    const cells = row.querySelectorAll('th');
                    console.log(`Header cells: ${cells.length}`);
                    cells.forEach((cell, cellIndex) => {
                        const colspan = cell.getAttribute('colspan') || '1';
                        console.log(`  Header Cell ${cellIndex + 1}: colspan=${colspan}`);
                    });
                    console.groupEnd();
                });
            }
            
            // Process only tbody rows (actual data)
            tbodyRows.forEach((row, index) => {
                console.group(`Data Row ${index + 1}`);
                
                const cells = row.querySelectorAll('td');
                console.log(`Cells: ${cells.length}`);
                
                cells.forEach((cell, cellIndex) => {
                    const colspan = cell.getAttribute('colspan') || '1';
                    const editableFields = cell.querySelectorAll('.editable-field');
                    
                    console.log(`  Cell ${cellIndex + 1}: colspan=${colspan}, editable fields: ${editableFields.length}`);
                    
                    editableFields.forEach((field, fieldIndex) => {
                        const value = field.textContent.trim() || '(empty)';
                        console.log(`    Field ${fieldIndex + 1}: "${value}"`);
                    });
                });
                
                console.groupEnd();
            });
            
            // Test specific field mappings
            console.group('🔍 FIELD MAPPING TEST');
            
            console.log('📋 FIELD MAPPING STATUS:');
            for (let i = 1; i <= 5; i++) {
                const qtySelector = FIELD_MAPPING[`lineItem${i}Qty`];
                const itemSelector = FIELD_MAPPING[`lineItem${i}Item`];
                const descSelector = FIELD_MAPPING[`lineItem${i}Desc`];
                const optionsSelector = FIELD_MAPPING[`lineItem${i}Options`];
                const rateSelector = FIELD_MAPPING[`lineItem${i}Rate`];
                const amountSelector = FIELD_MAPPING[`lineItem${i}Amount`];
                
                const qtyElement = document.querySelector(qtySelector);
                const itemElement = document.querySelector(itemSelector);
                const descElement = document.querySelector(descSelector);
                const optionsElement = document.querySelector(optionsSelector);
                const rateElement = document.querySelector(rateSelector);
                const amountElement = document.querySelector(amountSelector);
                
                const qty = qtyElement ? '✅' : '❌';
                const item = itemElement ? '✅' : '❌';
                const desc = descElement ? '✅' : '❌';
                const options = optionsElement ? '✅' : '❌';
                const rate = rateElement ? '✅' : '❌';
                const amount = amountElement ? '✅' : '❌';
                
                console.log(`Line Item ${i}: Qty:${qty} Item:${item} Desc:${desc} Options:${options} Rate:${rate} Amount:${amount}`);
                
                // Show values for non-empty fields
                if (qtyElement && qtyElement.textContent.trim()) {
                    console.log(`  Qty: "${qtyElement.textContent.trim()}"`);
                }
                if (itemElement && itemElement.textContent.trim()) {
                    console.log(`  Item: "${itemElement.textContent.trim()}"`);
                }
                if (descElement && descElement.textContent.trim()) {
                    console.log(`  Desc: "${descElement.textContent.trim()}"`);
                }
                if (optionsElement && optionsElement.textContent.trim()) {
                    console.log(`  Options: "${optionsElement.textContent.trim()}"`);
                }
                if (rateElement && rateElement.textContent.trim()) {
                    console.log(`  Rate: "${rateElement.textContent.trim()}"`);
                }
                if (amountElement && amountElement.textContent.trim()) {
                    console.log(`  Amount: "${amountElement.textContent.trim()}"`);
                }
            }
            
            console.groupEnd();
            
            // Summary
            console.group('📊 SUMMARY');
            console.log('✅ All line item fields are now properly mapped!');
            console.log('📋 Line Item 1: Row 1 (tbody) - Sample data');
            console.log('📋 Line Item 2: Row 2 (tbody) - Sample data'); 
            console.log('📋 Line Item 3: Row 3 (tbody) - Empty (ready for use)');
            console.log('📋 Line Item 4: Row 4 (tbody) - Empty (ready for use)');
            console.log('📋 Line Item 5: Row 5 (tbody) - Empty (ready for use)');
            console.log('🎯 Total editable fields available: 30 (6 fields × 5 line items)');
            console.groupEnd();
            
            console.groupEnd();
            console.groupEnd();
        }

        // Simple test function to debug line item extraction
        function testLineItemExtraction() {
            console.group('🧪 LINE ITEM EXTRACTION TEST');
            
            const table = document.querySelector('table.itemtable');
            if (!table) {
                console.error('❌ Table not found');
                console.groupEnd();
                return;
            }
            
            const tbodyRows = table.querySelectorAll('tbody tr');
            console.log(`📊 Found ${tbodyRows.length} tbody rows`);
            
            tbodyRows.forEach((row, index) => {
                console.group(`Row ${index + 1}`);
                
                const cells = row.querySelectorAll('td');
                console.log(`Cells: ${cells.length}`);
                
                cells.forEach((cell, cellIndex) => {
                    const editableFields = cell.querySelectorAll('.editable-field');
                    console.log(`  Cell ${cellIndex + 1}: ${editableFields.length} editable fields`);
                    
                    editableFields.forEach((field, fieldIndex) => {
                        const value = field.textContent.trim();
                        const isEmpty = !value;
                        console.log(`    Field ${fieldIndex + 1}: "${value}" (empty: ${isEmpty})`);
                    });
                });
                
                // Test the extraction logic
                if (cells.length >= 5) {
                    const qty = cells[0]?.querySelector('.editable-field')?.textContent.trim() || '';
                    const itemElement = cells[1]?.querySelector('.itemname .editable-field');
                    const descElement = cells[1]?.querySelector('.editable-field:nth-of-type(2)');
                    const item = itemElement?.textContent.trim() || '';
                    const desc = descElement?.textContent.trim() || '';
                    const options = cells[2]?.querySelector('.editable-field')?.textContent.trim() || '';
                    const rate = cells[3]?.querySelector('.editable-field')?.textContent.trim() || '';
                    const amount = cells[4]?.querySelector('.editable-field')?.textContent.trim() || '';
                    
                    console.log(`📋 Extraction test:`);
                    console.log(`  Qty: "${qty}"`);
                    console.log(`  Item: "${item}"`);
                    console.log(`  Desc: "${desc}"`);
                    console.log(`  Options: "${options}"`);
                    console.log(`  Rate: "${rate}"`);
                    console.log(`  Amount: "${amount}"`);
                    
                    const hasContent = qty || item || desc || rate || amount;
                    console.log(`  Has content: ${hasContent}`);
                }
                
                console.groupEnd();
            });
            
            console.groupEnd();
        }

        // Simple test to see what getLineItems() returns
        function testGetLineItems() {
            console.group('🧪 TEST GET LINE ITEMS');
            
            const result = getLineItems();
            console.log('📋 getLineItems() returned:');
            console.log('Length:', result.length);
            console.log('Content:', result);
            
            // Test parsing the result
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = result;
            const rows = tempDiv.querySelectorAll('tr');
            console.log('📊 Parsed rows:', rows.length);
            
            rows.forEach((row, index) => {
                const cells = row.querySelectorAll('td');
                console.log(`Row ${index + 1}: ${cells.length} cells`);
                cells.forEach((cell, cellIndex) => {
                    console.log(`  Cell ${cellIndex + 1}: "${cell.textContent.trim()}"`);
                });
            });
            
            console.groupEnd();
        }
    </script>
</body>
</html>
